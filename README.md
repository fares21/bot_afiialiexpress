# AliExpress Telegram Bot + Admin Panel (Node.js, Telegraf, Express, PostgreSQL)

## نظرة عامة

هذا المشروع عبارة عن بوت تلغرام مكتوب بـ Node.js باستخدام مكتبة Telegraf، مع لوحة إدارة مبنية باستخدام Express وEJS، وقاعدة بيانات PostgreSQL لتخزين المستخدمين والمشرفين والجلسات.  
يقوم البوت بتحليل روابط منتجات AliExpress، واستخراج `productId`، وجلب بيانات السعر والشحن إلى الجزائر بالدولار، والكوبونات العالمية وكوبونات البائع (عبر API خارجي تقوم بضبطه)، ثم حساب السعر النهائي وعرض النتائج بالعربية الرسمية.  

## المتطلبات

- Node.js 18 أو أحدث  
- PostgreSQL  
- حساب بوت تلغرام (Token من BotFather)  
- API خارجي أو خدمة خاصة بك لجلب بيانات منتجات AliExpress (يتم ضبط عنوانها ومفتاحها في ملف `.env`)  

## تنصيب المشروع

1. استنساخ المستودع أو إنشاء مجلد جديد ووضع الملفات كما هو موضح في هذا المشروع.  
2. تثبيت الحزم:

npm install

3. إنشاء ملف `.env` في جذر المشروع وملؤه كما في المثال الموجود في هذا الملف (مع تعديل القيم حسب بيئتك الفعلية).  
4. التأكد من ضبط متغير `DATABASE_URL` ليتوافق مع إعدادات PostgreSQL لديك.  

## تشغيل المشروع

للتشغيل في وضع التطوير:


npm start

- إذا كان `USE_WEBHOOK=false` في `.env`، سيعمل البوت بوضع Polling.  
- إذا كان `USE_WEBHOOK=true`، يجب ضبط `PUBLIC_URL` وفتح المنفذ المطلوب، وسيتم ربط البوت بـ Express عبر Webhook.  

## لوحة الإدارة

- مسار لوحة الإدارة هو: `/admin` (مثال: `http://localhost:3000/admin`).  
- عند أول تشغيل، سيتم إنشاء حساب مشرف افتراضي اعتماداً على القيم في `.env`:
  - اسم المستخدم الافتراضي: `Fares21`  
  - كلمة المرور الافتراضية: `Bouaffar@@1987`  
- كلمة المرور تُخزَّن في قاعدة البيانات باستخدام `bcrypt` بتشفير قوي (عدد دورات SALT_ROUNDS = 12)، ويمكنك تغييره من ملف `src/db/queries.js` إذا رغبت.  

### تسجيل الدخول

- انتقل إلى `/admin/login` وأدخل بيانات المشرف.  
- نظام تسجيل الدخول يعتمد على:
  - جلسات `express-session` مع تخزين في PostgreSQL عبر `connect-pg-simple`.  
  - حماية CSRF باستخدام `csurf`.  
  - Rate Limiting لمحاولات تسجيل الدخول لمنع التخمين.  

## نظام البث (Broadcast)

داخل لوحة الإدارة، يمكنك إرسال رسالة إلى جميع المستخدمين النشطين المشتركين عبر نموذج يحتوي على Textarea وزر إرسال.  

- تتم عملية الإرسال على دفعات Batch-by-Batch (قابلة للتعديل عبر متغيرات البيئة `BROADCAST_BATCH_SIZE` و `BROADCAST_BATCH_DELAY_MS`).  
- يتم تخطي المستخدمين غير النشطين تلقائياً عند حدوث أخطاء مثل حظر البوت أو عدم توفر المستخدم.  
- بعد الإرسال، تظهر لك إحصائيات بعدد من أُرسلت إليهم الرسالة ومن فشلت عملية الإرسال لهم.  

## منطق تحليل روابط AliExpress

1. عند إرسال أي نص للبوت، يتم البحث عن أول رابط داخل النص.  
2. يتم التحقق من أن الرابط يتبع نطاق AliExpress، ثم محاولة استخراج `productId` بأنماط متعددة عبر الملف:
   - `src/bot/utils/extractProductId.js`  
3. إذا فشل الاستخراج أو لم يكن الرابط من AliExpress، يتم الرد برسالة رسمية بأن الرابط غير مدعوم.  
4. إذا تم استخراج `productId` بنجاح، يتم استدعاء API خارجي (تعريفه في `.env`) للحصول على بيانات المنتج، ثم حساب السعر النهائي وعرض النتائج بالعربية الرسمية للمستخدم.  

## ملاحظات أمنية

- تأكد من استخدام HTTPS في بيئة الإنتاج، وضبط خيار `cookie.secure` في الجلسات إلى `true`.  
- استخدم قيم سرية طويلة ومعقدة في متغيري `SESSION_SECRET` و `ALIEXPRESS_API_KEY`.  
- لا تقم بمشاركة ملف `.env` أو بيانات تسجيل الدخول للمشرف في مستودعات عامة.  

## تطوير وتخصيص

يمكنك توسيع المشروع عبر:  

- إضافة أوامر جديدة للبوت (مثل أوامر إحصائية أو دعم لعملات أخرى).  
- تحسين منطق تحليل الأسعار والكوبونات حسب شكل استجابة الـ API الفعلية لديك.  
- إضافة صفحات إضافية في لوحة الإدارة مثل عرض قائمة المستخدمين أو إحصائيات البوت.  

## إيقاف البوت والخادم

يتم التعامل مع إشارات النظام `SIGINT` و`SIGTERM` لإيقاف البوت بشكل آمن.  
يمكنك إيقاف التطبيق عبر الأمر:  


